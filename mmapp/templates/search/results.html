<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css"
      integrity="sha384-KyZXEAg3QhqLMpG8r+Knujsl5/a1H3wzLl9x3XZrUJr59lW6pXb5JNp3gHy7hE4j"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles.css" />
    <title>MapMind</title>
    <style>
      .search-bar-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 999;
        padding: 10px;
      }
      #viewbox {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        overflow: hidden;
      }

      #sidebox {
        z-index: 997;
      }

      #navbuttons {
        z-index: 998;
      }

      body {
        margin-bottom: 60px; /* make room for the fixed search bar */
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div class="container" style="overflow: hidden">
      <div class="row my-1">
        <div class="col-9"></div>
        <div class="col" id="navbuttons">
          <a href="/" class="mx-2">
            <i class="bi bi-house-door" style="font-size: 2rem"></i>
          </a>
          <a href="/notebooks" class="mx-2" id="notebooks_nav">
            <i class="bi bi-journal-text" style="font-size: 2rem"></i>
          </a>
          <a href="/settings" class="mx-2" id="settings_nav">
            <i class="bi bi-gear" style="font-size: 2rem"></i>
          </a>
          <a href="/accounts/logout" class="mx-2" id="logout_button">
            <i class="bi bi-door-open" style="font-size: 2rem"></i>
          </a>
        </div>
      </div>

      <div id="viewbox"></div>
      <div class="col-md-4" id="sidebar">
        <ul class="list-group my-5 mx-2 rounded"></ul>
      </div>
      <div class="row">
        <div class="col"></div>
        <div class="search-bar mx-12">
          <div class="col search-bar-container py-3">
            {% if not error %}
            <div
              class="alert alert-danger"
              role="alert"
              id="search-error"
              hidden
            ></div>
            {% else %}
            <div class="alert alert-danger" role="alert" id="search-error">
              {{errorMsg}}
            </div>
            {% endif %}
            <form id="search-form" class="mb-5">
              <div class="row justify-content-center my-2">
                <div class="col-6">
                  <input
                    type="text"
                    id="search_words"
                    name="search_words"
                    class="form-control w-10 rounded-pill"
                    placeholder="Search..."
                    maxlength="200"
                    required
                  />
                </div>

                <div class="col-2">
                  <select
                    id="notebook"
                    name="notebook"
                    class="form-select ms-2 rounded rounded-pill"
                    aria-label="Select notebook"
                    required
                  >
                    {% for notebook in notebooks %}
                    <option value="{{ notebook.id }}">
                      {{ notebook.name }}
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-2">
                  <button
                    type="submit"
                    class="btn btn-primary ms-3 rounded-pill"
                    data-toggle="tooltip"
                    data-placement="top"
                    title="Search may take a few seconds as we scour your notes."
                  >
                    Search
                  </button>
                </div>
              </div>
              <div class="row my-2">
                <div class="col d-flex justify-content-center">
                  <div class="form-check me-4">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="spellcheck"
                      name="spellcheck"
                    />
                    <label class="form-check-label" for="spellcheck">
                      Spellcheck
                    </label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="notesonly"
                      name="notesonly"
                    />
                    <label class="form-check-label" for="notesonly">
                      Search notes only
                    </label>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div class="col"></div>
      </div>
    </div>
    <div id="loading-spinner" class="text-center sticky-bottom" hidden>
      <div class="spinner-grow text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="spinner-grow text-secondary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="spinner-grow text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="spinner-grow text-danger" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="spinner-grow text-warning" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="spinner-grow text-info" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="spinner-grow text-dark" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <script>
      const searchForm = document.getElementById("search-form");
      const navButtons = document.getElementById("navbuttons");
      const sidebar = document.getElementById("sidebar");
      let scrollTimeout = 500;

      window.addEventListener("wheel", () => {
        clearTimeout(scrollTimeout); // Clear any existing timeout
        searchForm.style.display = "none"; // Hide the search form when scrolling
        navButtons.style.display = "none"; // Hide the nav buttons when scrolling
        sidebar.style.display = "none"; // Hide the sidebar when scrolling

        // Set a timeout to show the search form after 100 milliseconds (or any desired time) of inactivity
        scrollTimeout = setTimeout(() => {
          searchForm.style.display = "block";
          navButtons.style.display = "block";
          sidebar.style.display = "block";
        }, 500);
      });

      document.addEventListener("keydown", (event) => {
        if (
          event.key == "ArrowLeft" ||
          event.key == "ArrowRight" ||
          event.key == "ArrowUp" ||
          event.key == "ArrowDown"
        ) {
          searchForm.style.display = "none";
          navButtons.style.display = "none";
          sidebar.style.display = "none";
        }
      });

      document.addEventListener("keyup", (event) => {
        if (
          event.key == "ArrowLeft" ||
          event.key == "ArrowRight" ||
          event.key == "ArrowUp" ||
          event.key == "ArrowDown"
        ) {
          scrollTimeout = setTimeout(() => {
            searchForm.style.display = "block";
            navButtons.style.display = "block";
            sidebar.style.display = "block";
          }, 500);
        }
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    >

      function showSpinner() {
        document.getElementById("loading-spinner").hidden = false;
      }

      function hideSpinner() {
        document.getElementById("loading-spinner").hidden = true;
      }

      // Error messages from:
        // https://getbootstrap.com/docs/4.3/components/alerts/
        // https://www.tutorialsteacher.com/jquery/jquery-ajax-method
        // http://api.jquery.com/jQuery.ajax/#jqXHR


      $("#search-form").submit(function (e) {
        e.preventDefault();
        var search_words = $("#search_words").val();
        var notebook = $("#notebook").val();
        $.ajax({
          url: "/search_results",
          type: "GET",
          data: {
            search_words: search_words,
            notebook: notebook,
          },
          success: function (data) {
            console.log(data);
          },
          error: function(jqXhr, textStatus, errorMessage) {
            if (jqXhr.status == 400) {
              document.getElementById("search_error").hidden = false;
              document.getElementById("search_error").innerText = jqXhr.responseText;
            }
            else {
              document.getElementById("search_error").hidden = false;
              document.getElementById("search_error").innerText = "Error when searching!";
            }
          }
        });
      });
    </script>
    <script
      async
      src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"
    ></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.138.3/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.138.3/examples/jsm/"
        }
      }
    </script>
    <script type="module">
      import * as THREE from "three";
      import { FontLoader } from "three/addons/loaders/FontLoader.js";
      import { TextGeometry } from "three/addons/geometries/TextGeometry.js";
      import { Vector3 } from "three";

      // https://threejs.org/docs/#api/en/helpers/AxesHelper
      // https://stackoverflow.com/questions/13039589/rotate-the-camera-around-an-object-using-the-arrow-keys-in-three-js
      // http://jsfiddle.net/HXms8/4/
      // https://stackoverflow.com/questions/24690731/three-js-3d-models-as-hyperlink
      // http://soledadpenades.com/articles/three-js-tutorials/object-picking/
      // https://blog.hubspot.com/website/html-dropdown
      // https://javascript.plainenglish.io/intro-to-raycasting-in-three-js-211ac4aae768
      // https://sbcode.net/threejs/raycaster/
      // https://discourse.threejs.org/t/click-event-on-object/1320/2
      // https://stackoverflow.com/questions/1085801/get-selected-value-in-dropdown-list-using-javascript
      // use this? https://github.com/yomotsu/camera-controls
      // https://www.freecodecamp.org/news/here-is-the-most-popular-ways-to-make-an-http-request-in-javascript-954ce8c95aaa/
      // https://stackoverflow.com/questions/45353282/how-to-zoom-a-three-js-scene-with-the-mouse-wheel

      // Spherical coordinates of camera
      var theta = 0;
      var phi = 90;
      var dis = 30;

      console.log("reporting to you live from results");

      // Function that computes the new position of the camera after a rotation or zoom
      function computeNewCameraPostion() {
        camera.position.x =
          dis *
          Math.sin(phi * (Math.PI / 180)) *
          Math.sin(theta * (Math.PI / 180));
        camera.position.z =
          dis *
          Math.sin(phi * (Math.PI / 180)) *
          Math.cos(theta * (Math.PI / 180));
        camera.position.y = dis * Math.cos(phi * (Math.PI / 180));
        console.log(
          camera.position.x + " " + camera.position.y + " " + camera.position.z
        );
      }

      // Rotation logic
      // FR#16 -- Visualization.Rotate
      document.addEventListener("keydown", (event) => {
        if (event.key == "ArrowLeft") {
          theta -= 1;
          computeNewCameraPostion();
          camera.lookAt(0, 0, 0);
        } else if (event.key == "ArrowRight") {
          theta += 1;
          computeNewCameraPostion();
          camera.lookAt(0, 0, 0);
        } else if (event.key == "ArrowUp") {
          phi -= 1;
          console.log(phi);
          if (phi <= 0) {
            phi = 1;
          }
          computeNewCameraPostion();
          camera.lookAt(0, 0, 0);
        } else if (event.key == "ArrowDown") {
          phi += 1;
          console.log(phi);
          if (phi >= 180) {
            phi = 179;
          }
          computeNewCameraPostion();
          camera.lookAt(0, 0, 0);
        }
      });

      // For zooming in and out with scroll wheel
      // FR#15 -- Visualization.Zoom
      document.addEventListener("wheel", (event) => {
        dis += 0.001 * event.deltaY;
        // min zoom
        if (dis < 5.0) {
          dis = 5;
        }
        // max zoom
        else if (dis > 100.0) {
          dis = 100;
        }
        computeNewCameraPostion();
        camera.lookAt(0, 0, 0);
      });

      
      function showSpinner() {
        document.getElementById("loading-spinner").hidden = false;
      }

      function hideSpinner() {
        document.getElementById("loading-spinner").hidden = true;
      }


      var div = document.getElementById("viewbox");
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff);
      const camera = new THREE.PerspectiveCamera(
        75,
        div.clientWidth / div.clientHeight,
        0.1,
        6000
      );
      const renderer = new THREE.WebGLRenderer();
      const raycaster = new THREE.Raycaster();
      renderer.setSize(div.clientWidth, div.clientHeight);
      div.appendChild(renderer.domElement);

      // const geometry = new THREE.BoxGeometry( 1, 1, 1 );
      // const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
      // const cube = new THREE.Mesh( geometry, material );
      // scene.add( cube );

      const axesHelper = new THREE.AxesHelper(dis * 100);
      scene.add(axesHelper);

      computeNewCameraPostion();
      camera.lookAt(0, 0, 0);

      const loader = new FontLoader();
      loader.load(
        "https://unpkg.com/three@0.138.3/examples/fonts/helvetiker_regular.typeface.json",
        generateText
      );

      var meshes = [];
      var searched_terms = [];

      // setup for when select menu implmented
      var notebookId = document.getElementById("notebook").value;

      function generateText(font) {
        //https://stackoverflow.com/questions/43305020/how-to-use-the-context-variables-passed-from-django-in-javascript
        var list = JSON.parse("{{words_pos|escapejs}}");
        var skipped_list = JSON.parse("{{skipwords|escapejs}}");
        var skipped_string = "";
        console.log(skipped_list);
        for (let i = 0; i < skipped_list.length; i++) {
          skipped_string += skipped_list[i] + ", ";
        }
        if (skipped_list.length > 0) {
          document.getElementById("search_error").hidden = false;
          document.getElementById("search_error").innerText =
            "The following words were not in your notes and skipped: " +
            skipped_string.substring(0, skipped_string.length - 2);
        }
        console.log(list);
        for (let i = 0; i < list.length; i++) {
          const geometry = new TextGeometry(list[i].string, {
            font: font,
            size: 1,
            height: 0.1,
          });
          geometry.translate(40 * list[i].pos[0],  40 * list[i].pos[2], 40 * list[i].pos[1]);
          const material = new THREE.MeshBasicMaterial({ color: 0x000000 });
          const textMesh = new THREE.Mesh(geometry, material);
          // https://threejs.org/docs/#api/en/math/Box3
          searched_terms.push(list[i].string);
          const box = new THREE.Box3();
          textMesh.geometry.computeBoundingBox();
          box.copy(textMesh.geometry.boundingBox).applyMatrix4(textMesh.matrixWorld);
          const center = new Vector3()
          box.getCenter(center)
          const size = new Vector3()
          box.getSize(size);
          const boxGeo = new THREE.BoxGeometry(size.x, size.y, size.z);
          const material_col = new THREE.MeshBasicMaterial({visible: false});
          const collMesh = new THREE.Mesh(boxGeo, material_col);
          collMesh.position.x = center.x;
          collMesh.position.y = center.y;
          collMesh.position.z = center.z;
          scene.add(textMesh);
          scene.add(collMesh);
          collMesh.userData = list[i].string;
          meshes.push(collMesh);
          textMesh.lookAt(camera.position);
        }

        div.addEventListener("mousedown", mouseDown);

        function generateSidebar(results) {
          var sidebar = document.getElementById("sidebar");
          if (!Array.isArray(results) || !results.length) {
            // array does not exist or is empty
            document.getElementById("search_error").hidden = false;
            document.getElementById("search_error").innerText =
              "This word is not in your notes!";
          } else {
            document.getElementById("search_error").hidden = true;
            sidebar.innerHTML = "";
            for (let result of results) {
              let newRow = document.createElement("li");
              newRow.className = "list-group-item rounded";
              newRow.textContent = escapeHtml(result);
              sidebar.appendChild(newRow);
            }
          }
        }

        // https://stackoverflow.com/questions/6234773/can-i-escape-html-special-chars-in-javascript
        // in case they somehow inject HTML?
        function escapeHtml(unsafe) {
          return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        // FR#17 -- Inspect.Node
        function mouseDown(event) {
          // https://stackoverflow.com/questions/34892328/detection-with-raycaster-not-completely-accurate-when-the-width-of-div-is-reduce
          var rect = renderer.domElement.getBoundingClientRect();
          const mouse = new THREE.Vector2();
          mouse.x =
            ((event.clientX - rect.left) / renderer.domElement.clientWidth) *
              2 -
            1;
          mouse.y =
            -((event.clientY - rect.top) / renderer.domElement.clientHeight) *
              2 +
            1;
          raycaster.setFromCamera(mouse, camera);
          const intersects = raycaster.intersectObjects(meshes, false);
          console.log(mouse)
          console.log(intersects);
          if (intersects.length > 0) {
            // just to verify the sidebar function works
            // generateSidebar(["hello", "world", "item", "yes"]);

            // send request to backend
            showSpinner();
            var request = new XMLHttpRequest();
            request.open("POST", "/inspect_node");
            request.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            request.onreadystatechange = function () {
              if (request.readyState == 4) {
                if (request.status == 200) {
                  let obj = JSON.parse(request.responseText);
                  console.log(obj);
                  generateSidebar(obj);
                  hideSpinner();
                } else if (request.status == 400) {
                  document.getElementById("search-error").hidden = false;
                  document.getElementById("search-error").innerText =
                    request.responseText;
                    hideSpinner();
                } else {
                  document.getElementById("search-error").hidden = false;
                  document.getElementById("search-error").innerText =
                    "Error when inspecting node!";
                    hideSpinner();
                }
              }
            };
            let send_obj_json = {
              notebook_id: document.getElementById("notebook").value,
              searched_words: searched_terms,
              word: intersects[0].object.userData,
            };
            request.send(JSON.stringify(send_obj_json));
            console.log(intersects[0].object.userData);
          }
        }

        function animate() {
          requestAnimationFrame(animate);
          renderer.render(scene, camera);
        }
        animate();
      }
    </script>
  </body>
</html>
